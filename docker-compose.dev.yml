version: '3.8'

services:
  # SimpleSAMLphp as test Identity Provider
  saml-idp:
    build:
      context: .
      dockerfile: Dockerfile.saml-idp
    container_name: slurm-saml-idp
    ports:
      - "8080:8080"
    volumes:
      - ./docker/saml-idp/authsources.php:/var/www/simplesamlphp/config/authsources.php
      - ./docker/saml-idp/saml20-sp-remote.php:/var/www/simplesamlphp/metadata/saml20-sp-remote.php
    networks:
      - slurm-network

  # Backend with SAML support
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend.dev
    container_name: slurm-backend-dev
    ports:
      - "8100:8100"
    environment:
      - ENVIRONMENT=development
      - DATA_PATH=/data
      - API_KEYS=dev-api-key-12345
      - AUTO_REFRESH_INTERVAL=600
      - CORS_ORIGINS=http://localhost:5173,http://localhost:3100,http://localhost:8100
      - ENABLE_SAML=true
      - SAML_SETTINGS_PATH=/app/saml/settings.json
      - SECRET_KEY=dev-secret-key-change-in-production-12345678901234567890
      - SUPERADMIN_EMAILS=admin@tudelft.nl,admin@example.com
      - DEBUG=true
      - RELOAD=true
      - SETUPTOOLS_SCM_PRETEND_VERSION=0.1.0
    volumes:
      - ./data:/data
      - ./backend:/app/backend
      - ./src:/app/src
      - ./saml:/app/saml
      - ./scripts:/app/scripts
      - ./frontend/dist:/app/frontend/dist
      - ./docker/saml-config/settings.json:/app/saml/settings.json
    depends_on:
      - saml-idp
    networks:
      - slurm-network
    command: ["uv", "run", "uvicorn", "backend.app.main:app", "--host", "0.0.0.0", "--port", "8100", "--reload"]

  # Frontend development server
  frontend:
    build:
      context: ./frontend
      dockerfile: ../Dockerfile.frontend.dev
    container_name: slurm-frontend-dev
    ports:
      - "5173:3100"
    environment:
      - VITE_API_URL=http://localhost:8100
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - slurm-network

networks:
  slurm-network:
    driver: bridge

volumes:
  data:
    driver: local
