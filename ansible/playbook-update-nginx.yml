---
# Playbook to update existing nginx configuration
# Use this if you already have nginx running with SSL
- name: Update nginx configuration for Slurm Usage History
  hosts: workstations
  become: yes
  vars:
    app_name: slurm-usage-history
    app_base_dir: "/opt/{{ app_name }}"
    frontend_build_dir: "{{ app_base_dir }}/frontend/dist"
    backend_port: 8100

  tasks:
    - name: Check if existing nginx config exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/default
      register: existing_nginx

    - name: Backup existing nginx configuration
      ansible.builtin.copy:
        src: /etc/nginx/sites-enabled/default
        dest: /etc/nginx/sites-enabled/default.backup.{{ ansible_date_time.iso8601_basic_short }}
        remote_src: yes
      when: existing_nginx.stat.exists

    - name: Update nginx configuration (merge with existing)
      ansible.builtin.template:
        src: nginx-merged.conf.j2
        dest: /etc/nginx/sites-available/slurm-usage-history
        owner: root
        group: root
        mode: '0644'
        backup: yes
      notify: Test and reload nginx

    - name: Enable new nginx configuration
      ansible.builtin.file:
        src: /etc/nginx/sites-available/slurm-usage-history
        dest: /etc/nginx/sites-enabled/slurm-usage-history
        state: link
      notify: Test and reload nginx

    - name: Display next steps
      ansible.builtin.debug:
        msg:
          - "Nginx configuration updated!"
          - "The new config is at: /etc/nginx/sites-available/slurm-usage-history"
          - "Your original config backup: /etc/nginx/sites-enabled/default.backup.*"
          - ""
          - "To switch to the new config:"
          - "  sudo rm /etc/nginx/sites-enabled/default"
          - "  sudo nginx -t"
          - "  sudo systemctl reload nginx"

  handlers:
    - name: Test and reload nginx
      ansible.builtin.shell: |
        nginx -t && systemctl reload nginx || (echo "Nginx config test failed" && exit 1)
