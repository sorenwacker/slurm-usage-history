# Nginx configuration for testing deployment alongside existing dashboard
#
# This configuration serves:
# 1. Old dashboard at /              (production, with SAML)
# 2. New dashboard at /v2-preview/   (testing, no SAML)

server {
    listen 443 ssl http2;
    server_name {{ nginx_server_name }};

    ssl_certificate {{ ssl_certificate_path }};
    ssl_certificate_key {{ ssl_certificate_key_path }};

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # =========================================================================
    # NEW DASHBOARD (Testing) - Secret URL for internal testing
    # Protected with HTTP Basic Auth
    # =========================================================================

    # Backend API for new dashboard (no SAML initially)
    location /v2-preview/api/ {
        # HTTP Basic Authentication
        auth_basic "Internal Testing - New Dashboard";
        auth_basic_user_file {{ app_base_dir }}/.htpasswd;

        proxy_pass http://127.0.0.1:{{ backend_port }}/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (if needed)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Frontend for new dashboard
    location /v2-preview/ {
        # HTTP Basic Authentication
        auth_basic "Internal Testing - New Dashboard";
        auth_basic_user_file {{ app_base_dir }}/.htpasswd;

        alias {{ app_base_dir }}/frontend/dist/;
        try_files $uri $uri/ /v2-preview/index.html;

        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # =========================================================================
    # OLD DASHBOARD (Production) - Keep existing configuration
    # =========================================================================

    # Existing Dash app - keep your current configuration here
    # This should proxy to wherever your old dashboard runs (likely port 8050)
    location / {
        # Replace with your actual old dashboard proxy configuration
        proxy_pass http://127.0.0.1:8050;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Existing SAML endpoints for old dashboard
    location /saml/ {
        proxy_pass http://127.0.0.1:8050/saml/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # Health checks
    # =========================================================================

    location /health/new {
        proxy_pass http://127.0.0.1:{{ backend_port }}/health;
        access_log off;
    }
}

server {
    listen 80;
    server_name {{ nginx_server_name }};
    return 301 https://$server_name$request_uri;
}
